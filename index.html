<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½æ¯›çƒåœºåœ°è´¹ç”¨åˆ†æ‘Šç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .sync-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 15px;
            font-weight: 600;
        }

        .sync-status.success {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .sync-status.loading {
            background: #fff3cd;
            color: #856404;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .panel h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .member-list {
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .member-item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            margin-bottom: 0;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
            position: relative;
        }

        .member-item:hover {
            background: #e9ecef;
        }

        .member-item:hover .delete-member-btn {
            opacity: 1;
        }

        .member-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .member-name {
            font-weight: 500;
            color: #333;
            border: none;
            background: transparent;
            font-size: 13px;
            cursor: pointer;
            min-width: 0;
            flex-shrink: 1;
        }

        .member-name:focus {
            outline: 2px solid #667eea;
            border-radius: 4px;
            padding: 2px 5px;
        }

        .member-balance {
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }

        .balance-positive {
            color: #28a745;
        }

        .balance-negative {
            color: #dc3545;
        }

        .delete-member-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
            margin-top: 5px;
            width: 100%;
        }

        .delete-member-btn:hover {
            background: #c82333;
        }

        .delete-member-btn:active {
            transform: scale(0.98);
        }

        .add-member-section {
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .add-member-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item.selected {
            background: #e7f3ff;
            border-color: #667eea;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            margin: 0;
            margin-right: 8px;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 13px;
            user-select: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            flex: 1;
        }

        .result-box {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-box h3 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .result-box p {
            color: #333;
            margin: 5px 0;
            font-size: 14px;
        }

        .result-amount {
            font-size: 24px;
            font-weight: bold;
            color: #0066cc;
            margin: 10px 0;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .history-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .history-participants {
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }

        .history-amount {
            font-weight: bold;
            color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card-blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-card-green {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .stat-card-orange {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .stat-card-title {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-card-value {
            font-size: 20px;
            font-weight: bold;
        }

        .verification-box {
            padding: 12px;
            background: #fff3cd;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }

        .verification-box p {
            font-size: 13px;
            color: #856404;
            margin: 3px 0;
        }

        .gist-config {
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .gist-config h3 {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .gist-config input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .gist-config small {
            display: block;
            color: #666;
            font-size: 11px;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .member-list {
                grid-template-columns: 1fr;
            }

            .checkbox-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¸ ç¾½æ¯›çƒåœºåœ°è´¹ç”¨åˆ†æ‘Šç³»ç»Ÿ</h1>
            <p>å¤šäººå…±äº«å‚¨å€¼å¡ - è´¹ç”¨è‡ªåŠ¨è®¡ç®—ä¸è®°å½•
                <span id="syncStatus" class="sync-status" style="display: none;"></span>
            </p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§ï¼šæˆå‘˜ç®¡ç†å’Œç»Ÿè®¡ -->
            <div class="panel">
                <h2>ğŸ‘¥ æˆå‘˜ç®¡ç†</h2>
                
                <!-- Gisté…ç½® -->
                <div class="gist-config">
                    <h3>â˜ï¸ äº‘ç«¯åŒæ­¥è®¾ç½®</h3>
                    <input type="password" id="githubToken" placeholder="GitHub Token" value="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">
                    <small>Tokenä¼šä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œè¯·å¦¥å–„ä¿ç®¡</small>
                    <input type="text" id="gistId" placeholder="Gist ID" value="37d771bfb83331c087782545b0ca1154">
                    <input type="text" id="gistFilename" placeholder="æ–‡ä»¶å" value="badminton.json">
                    <button class="btn btn-primary btn-small" onclick="saveGistConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                </div>

                <!-- æ·»åŠ æˆå‘˜ -->
                <div class="add-member-section">
                    <input type="text" id="newMemberName" class="add-member-input" placeholder="è¾“å…¥æ–°æˆå‘˜å§“å">
                    <input type="number" id="newMemberBalance" class="add-member-input" placeholder="è¾“å…¥æ–°æˆå‘˜ä½™é¢ï¼ˆé»˜è®¤0ï¼‰" value="0" step="0.01">
                    <button class="btn btn-primary btn-small" onclick="addMember()">â• æ·»åŠ æˆå‘˜</button>
                </div>

                <!-- æˆå‘˜åˆ—è¡¨ -->
                <div class="member-list" id="memberList"></div>
                
                <!-- ç»Ÿè®¡æ•°æ® -->
                <div class="stats-grid">
                    <div class="stat-card stat-card-blue">
                        <div class="stat-card-title">ğŸ’³ å¡å†…ä½™é¢</div>
                        <div class="stat-card-value" id="cardBalanceDisplay">Â¥0.00</div>
                    </div>
                    <div class="stat-card stat-card-green">
                        <div class="stat-card-title">ğŸ’° ç°é‡‘æ€»é¢</div>
                        <div class="stat-card-value" id="cashTotalDisplay">Â¥0.00</div>
                    </div>
                </div>

                <div class="stat-card stat-card-orange" style="margin-bottom: 15px;">
                    <div class="stat-card-title">ğŸ‘¥ æˆå‘˜ä½™é¢æ€»å’Œ</div>
                    <div class="stat-card-value" id="membersTotalDisplay">Â¥0.00</div>
                </div>

                <!-- éªŒè¯ä¿¡æ¯ -->
                <div class="verification-box" id="verificationBox">
                    <p><strong>âœ“ è´¦ç›®éªŒè¯</strong></p>
                    <p id="verificationText">æˆå‘˜ä½™é¢æ€»å’Œ = å¡å†…ä½™é¢ + ç°é‡‘æ€»é¢</p>
                </div>
                
                <div style="border-top: 2px solid #eee; padding-top: 15px; margin-top: 15px;">
                    <button class="btn btn-warning" onclick="syncToGist()" id="syncBtn">
                        â˜ï¸ åŒæ­¥åˆ°äº‘ç«¯
                    </button>
                    <button class="btn btn-primary" onclick="loadFromGist()">
                        â˜ï¸ ä»äº‘ç«¯åŠ è½½
                    </button>
                    <div class="file-input-wrapper">
                        <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                            ğŸ“ ä»æ–‡ä»¶åŠ è½½
                        </button>
                        <input type="file" id="fileInput" accept=".json">
                    </div>
                    <button class="btn btn-success" onclick="downloadRecord()">
                        ğŸ’¾ ä¸‹è½½åˆ°æœ¬åœ°
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ“ä½œåŒºåŸŸ -->
            <div>
                <div class="panel">
                    <h2>ğŸ“ æœ¬æ¬¡æ´»åŠ¨è®°å½•</h2>
                    
                    <div class="input-group">
                        <label>é€‰æ‹©å‚ä¸äººå‘˜ï¼š</label>
                        <div class="checkbox-grid" id="memberCheckboxes"></div>
                    </div>

                    <div class="input-group">
                        <label>ä¸´æ—¶äººå‘˜æ•°é‡ï¼š</label>
                        <input type="number" id="tempMembers" placeholder="æ— ä¸´æ—¶äººå‘˜è¯·è¾“å…¥0" value="0" min="0" step="1">
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">ä¸´æ—¶äººå‘˜å›ºå®šæ”¯ä»˜Â¥40ç°é‡‘ï¼Œå¤šä»˜çš„é’±å¹³å‡åˆ†é…ç»™åœ¨åœºå›ºå®šæˆå‘˜</small>
                    </div>

                    <div class="input-group">
                        <label>æ€»æ¶ˆè´¹é‡‘é¢ (Â¥)ï¼š</label>
                        <input type="number" id="totalCost" placeholder="è¯·è¾“å…¥æœ¬æ¬¡æ¶ˆè´¹é‡‘é¢" step="0.01" min="0">
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="calculateExpense()" style="flex: 2;">
                            âœ“ è®¡ç®—å¹¶è®°å½•
                        </button>
                        <button class="btn btn-secondary" onclick="resetCurrent()">
                            â†º é‡ç½®
                        </button>
                    </div>
                </div>

                <!-- è®¡ç®—ç»“æœ -->
                <div id="resultBox" style="display: none;"></div>

                <!-- å†å²è®°å½• -->
                <div class="panel" id="historyPanel" style="display: none;">
                    <h2>ğŸ“Š å†å²è®°å½•</h2>
                    <div class="history-list" id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        let members = [];
        let history = [];
        let selectedMembers = new Set();
        let cashTotal = 0;
        let cardBalance = 10000;
        let nextMemberId = 1;

        // Gisté…ç½®
        let gistConfig = {
            token: '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',
            gistId: '37d771bfb83331c087782545b0ca1154',
            filename: 'badminton.json'
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadGistConfig();
            loadFromGist(); // è‡ªåŠ¨ä»äº‘ç«¯åŠ è½½
        };

        // ä¿å­˜Gisté…ç½®
        function saveGistConfig() {
            gistConfig.token = document.getElementById('githubToken').value.trim();
            gistConfig.gistId = document.getElementById('gistId').value.trim();
            gistConfig.filename = document.getElementById('gistFilename').value.trim();
            
            localStorage.setItem('gistConfig', JSON.stringify(gistConfig));
            alert('äº‘ç«¯é…ç½®å·²ä¿å­˜ï¼');
        }

        // åŠ è½½Gisté…ç½®
        function loadGistConfig() {
            const saved = localStorage.getItem('gistConfig');
            if (saved) {
                try {
                    gistConfig = JSON.parse(saved);
                    document.getElementById('githubToken').value = gistConfig.token;
                    document.getElementById('gistId').value = gistConfig.gistId;
                    document.getElementById('gistFilename').value = gistConfig.filename;
                } catch (e) {
                    console.error('åŠ è½½Gisté…ç½®å¤±è´¥:', e);
                }
            }
        }

        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        function showSyncStatus(message, type) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.className = `sync-status ${type}`;
            statusEl.style.display = 'inline-block';
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // ä»GiståŠ è½½æ•°æ®
        async function loadFromGist() {
            try {
                showSyncStatus('æ­£åœ¨ä»äº‘ç«¯åŠ è½½...', 'loading');
                
                const url = `https://gist.githubusercontent.com/${gistConfig.gistId.split('/')[0]}/${gistConfig.gistId}/raw/${gistConfig.filename}`;
                const response = await fetch(url, {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.members && Array.isArray(data.members)) {
                    members = data.members;
                    if (data.history) history = data.history;
                    if (data.cashTotal !== undefined) cashTotal = data.cashTotal;
                    if (data.cardBalance !== undefined) cardBalance = data.cardBalance;
                    if (data.nextMemberId !== undefined) {
                        nextMemberId = data.nextMemberId;
                    } else {
                        nextMemberId = members.length > 0 ? Math.max(...members.map(m => m.id)) + 1 : 1;
                    }
                    
                    saveToLocalStorage();
                    renderMembers();
                    renderCheckboxes();
                    renderHistory();
                    updateStats();
                    resetCurrent();
                    
                    showSyncStatus('âœ“ ä»äº‘ç«¯åŠ è½½æˆåŠŸ', 'success');
                } else {
                    throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                console.error('ä»GiståŠ è½½å¤±è´¥:', error);
                showSyncStatus('âœ— åŠ è½½å¤±è´¥: ' + error.message, 'error');
                
                // åŠ è½½å¤±è´¥æ—¶ä»localStorageåŠ è½½
                loadFromLocalStorage();
                renderMembers();
                renderCheckboxes();
                renderHistory();
                updateStats();
            }
        }

        // åŒæ­¥åˆ°Gist
        async function syncToGist() {
            if (!gistConfig.token || !gistConfig.gistId || !gistConfig.filename) {
                alert('è¯·å…ˆé…ç½®GitHub Tokenã€Gist IDå’Œæ–‡ä»¶åï¼');
                return;
            }

            try {
                const syncBtn = document.getElementById('syncBtn');
                syncBtn.disabled = true;
                showSyncStatus('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', 'loading');

                const data = {
                    members: members,
                    history: history,
                    cashTotal: cashTotal,
                    cardBalance: cardBalance,
                    nextMemberId: nextMemberId,
                    lastUpdate: new Date().toISOString()
                };

                const response = await fetch(`https://api.github.com/gists/${gistConfig.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${gistConfig.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        files: {
                            [gistConfig.filename]: {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }

                showSyncStatus('âœ“ åŒæ­¥æˆåŠŸ', 'success');
                saveToLocalStorage();
            } catch (error) {
                console.error('åŒæ­¥åˆ°Gistå¤±è´¥:', error);
                showSyncStatus('âœ— åŒæ­¥å¤±è´¥: ' + error.message, 'error');
                alert('åŒæ­¥å¤±è´¥ï¼š' + error.message + '\n\nè¯·æ£€æŸ¥ï¼š\n1. Tokenæ˜¯å¦æ­£ç¡®\n2. Tokenæ˜¯å¦æœ‰gistæƒé™\n3. Gist IDæ˜¯å¦æ­£ç¡®');
            } finally {
                document.getElementById('syncBtn').disabled = false;
            }
        }

        // ä»localStorageåŠ è½½æ•°æ®
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('badmintonData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.members) members = data.members;
                    if (data.history) history = data.history;
                    if (data.cashTotal !== undefined) cashTotal = data.cashTotal;
                    if (data.cardBalance !== undefined) cardBalance = data.cardBalance;
                    if (data.nextMemberId !== undefined) nextMemberId = data.nextMemberId;
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                }
            }
        }

        // ä¿å­˜åˆ°localStorage
        function saveToLocalStorage() {
            const data = {
                members: members,
                history: history,
                cashTotal: cashTotal,
                cardBalance: cardBalance,
                nextMemberId: nextMemberId,
                lastUpdate: new Date().toISOString()
            };
            localStorage.setItem('badmintonData', JSON.stringify(data));
        }

        // æ·»åŠ æˆå‘˜
        function addMember() {
            const nameInput = document.getElementById('newMemberName');
            const balanceInput = document.getElementById('newMemberBalance');
            const name = nameInput.value.trim();
            const balance = parseFloat(balanceInput.value) || 0;
            
            if (!name) {
                alert('è¯·è¾“å…¥æˆå‘˜å§“åï¼');
                return;
            }

            if (members.some(m => m.name === name)) {
                alert('è¯¥æˆå‘˜å·²å­˜åœ¨ï¼');
                return;
            }

            const newMember = {
                id: nextMemberId++,
                name: name,
                balance: balance
            };

            members.push(newMember);
            nameInput.value = '';
            balanceInput.value = '0';

            saveToLocalStorage();
            renderMembers();
            renderCheckboxes();
            updateStats();

            alert(`æˆå‘˜ ${name} æ·»åŠ æˆåŠŸï¼ä½™é¢ï¼šÂ¥${balance.toFixed(2)}`);
        }

        // åˆ é™¤æˆå‘˜
        function deleteMember(id) {
            const member = members.find(m => m.id === id);
            if (!member) return;

            const confirmMsg = `ç¡®å®šè¦åˆ é™¤æˆå‘˜"${member.name}"å—ï¼Ÿ\n\nå½“å‰ä½™é¢ï¼šÂ¥${member.balance.toFixed(2)}\n${member.balance < 0 ? 'è¯¥æˆå‘˜éœ€è¦è´¡çŒ® Â¥' + Math.abs(member.balance).toFixed(2) + ' ç°é‡‘' : 'è¯¥æˆå‘˜å°†è·å¾— Â¥' + member.balance.toFixed(2) + ' ç°é‡‘'}`;
            
            if (!confirm(confirmMsg)) return;

            cashTotal -= member.balance;
            members = members.filter(m => m.id !== id);

            saveToLocalStorage();
            renderMembers();
            renderCheckboxes();
            updateStats();

            alert(`æˆå‘˜"${member.name}"å·²åˆ é™¤ï¼`);
        }

        // æ¸²æŸ“æˆå‘˜åˆ—è¡¨
        function renderMembers() {
            const memberList = document.getElementById('memberList');
            memberList.innerHTML = '';
            
            if (members.length === 0) {
                memberList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px; grid-column: 1/-1;">æš‚æ— æˆå‘˜ï¼Œè¯·æ·»åŠ æˆå‘˜</p>';
                return;
            }

            members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'member-item';
                
                const balanceClass = member.balance >= 0 ? 'balance-positive' : 'balance-negative';
                
                div.innerHTML = `
                    <div class="member-info">
                        <input type="text" class="member-name" value="${member.name}" 
                               onchange="updateMemberName(${member.id}, this.value)">
                        <span class="member-balance ${balanceClass}">Â¥${member.balance.toFixed(2)}</span>
                    </div>
                    <button class="delete-member-btn" onclick="event.stopPropagation(); deleteMember(${member.id})">åˆ é™¤</button>
                `;
                
                memberList.appendChild(div);
            });
        }

        // æ›´æ–°æˆå‘˜åç§°
        function updateMemberName(id, newName) {
            newName = newName.trim();
            if (!newName) {
                alert('æˆå‘˜å§“åä¸èƒ½ä¸ºç©ºï¼');
                renderMembers();
                return;
            }

            if (members.some(m => m.id !== id && m.name === newName)) {
                alert('è¯¥å§“åå·²è¢«ä½¿ç”¨ï¼');
                renderMembers();
                return;
            }

            const member = members.find(m => m.id === id);
            if (member) {
                member.name = newName;
                saveToLocalStorage();
                renderCheckboxes();
            }
        }

        // æ¸²æŸ“å¤é€‰æ¡†
        function renderCheckboxes() {
            const container = document.getElementById('memberCheckboxes');
            container.innerHTML = '';
            
            if (members.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px; grid-column: 1/-1;">è¯·å…ˆæ·»åŠ æˆå‘˜</p>';
                return;
            }

            members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.id = `checkbox-${member.id}`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `member-${member.id}`;
                checkbox.value = member.id;
                checkbox.onchange = function() {
                    toggleMember(member.id);
                };
                
                const label = document.createElement('label');
                label.htmlFor = `member-${member.id}`;
                label.textContent = member.name;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                div.onclick = function(e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        toggleMember(member.id);
                    }
                };
                
                container.appendChild(div);
            });
        }

        // åˆ‡æ¢æˆå‘˜é€‰æ‹©
        function toggleMember(id) {
            if (selectedMembers.has(id)) {
                selectedMembers.delete(id);
            } else {
                selectedMembers.add(id);
            }
            
            const checkboxDiv = document.getElementById(`checkbox-${id}`);
            if (checkboxDiv) {
                if (selectedMembers.has(id)) {
                    checkboxDiv.classList.add('selected');
                } else {
                    checkboxDiv.classList.remove('selected');
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('cardBalanceDisplay').textContent = `Â¥${cardBalance.toFixed(2)}`;
            document.getElementById('cashTotalDisplay').textContent = `Â¥${cashTotal.toFixed(2)}`;
            
            const membersTotal = members.reduce((sum, member) => sum + member.balance, 0);
            document.getElementById('membersTotalDisplay').textContent = `Â¥${membersTotal.toFixed(2)}`;
            
            const expectedTotal = cardBalance + cashTotal;
            const difference = Math.abs(membersTotal - expectedTotal);
            
            const verificationText = document.getElementById('verificationText');
            if (difference < 0.01) {
                verificationText.innerHTML = `âœ“ è´¦ç›®å¹³è¡¡ï¼šÂ¥${membersTotal.toFixed(2)} = Â¥${cardBalance.toFixed(2)} + Â¥${cashTotal.toFixed(2)}`;
                verificationText.style.color = '#155724';
            } else {
                verificationText.innerHTML = `âš  è´¦ç›®å·®å¼‚ï¼šÂ¥${difference.toFixed(2)}<br>æˆå‘˜æ€»å’Œï¼šÂ¥${membersTotal.toFixed(2)} | é¢„æœŸï¼šÂ¥${expectedTotal.toFixed(2)}`;
                verificationText.style.color = '#856404';
            }
        }

        // è®¡ç®—è´¹ç”¨
        function calculateExpense() {
            if (members.length === 0) {
                alert('è¯·å…ˆæ·»åŠ æˆå‘˜ï¼');
                return;
            }

            if (selectedMembers.size === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå‚ä¸äººå‘˜ï¼');
                return;
            }

            const totalCostInput = document.getElementById('totalCost');
            const cost = parseFloat(totalCostInput.value);
            
            if (isNaN(cost) || cost <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆè´¹é‡‘é¢ï¼');
                return;
            }

            const tempMembersInput = document.getElementById('tempMembers');
            const temporaryCount = parseInt(tempMembersInput.value) || 0;
            
            if (temporaryCount < 0) {
                alert('ä¸´æ—¶äººå‘˜æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°ï¼');
                return;
            }

            const fixedMemberCount = selectedMembers.size;
            const totalPeople = fixedMemberCount + temporaryCount;
            
            const perPersonCost = cost / totalPeople;
            const temporaryPayment = 40;
            const totalTemporaryPayment = temporaryPayment * temporaryCount;
            const temporaryShouldPay = perPersonCost * temporaryCount;
            const temporaryExtra = totalTemporaryPayment - temporaryShouldPay;
            const temporaryIncomePerFixed = temporaryCount > 0 ? temporaryExtra / fixedMemberCount : 0;
            const fixedMemberActualCost = perPersonCost - temporaryIncomePerFixed;
            
            members.forEach(member => {
                if (selectedMembers.has(member.id)) {
                    member.balance -= fixedMemberActualCost;
                }
            });

            cashTotal += totalTemporaryPayment;
            cardBalance -= cost;

            const participantNames = Array.from(selectedMembers).map(id => 
                members.find(m => m.id === id).name
            );

            const record = {
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleString('zh-CN'),
                participants: participantNames,
                totalCost: cost,
                temporaryCount: temporaryCount,
                totalPeople: totalPeople,
                perPersonCost: perPersonCost,
                temporaryPayment: temporaryPayment,
                totalTemporaryPayment: totalTemporaryPayment,
                temporaryShouldPay: temporaryShouldPay,
                temporaryExtra: temporaryExtra,
                temporaryIncomePerFixed: temporaryIncomePerFixed,
                fixedMemberActualCost: fixedMemberActualCost,
                cardBalanceAfter: cardBalance,
                cashTotalAfter: cashTotal
            };

            history.unshift(record);

            saveToLocalStorage();
            renderMembers();
            updateStats();
            showResult(record);
            renderHistory();
        }

        // æ˜¾ç¤ºè®¡ç®—ç»“æœ
        function showResult(record) {
            const resultBox = document.getElementById('resultBox');
            resultBox.style.display = 'block';
            resultBox.className = 'result-box';
            
            let temporaryInfo = '';
            if (record.temporaryCount > 0) {
                temporaryInfo = `
                    <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 6px; margin-top: 10px;">
                        <p style="color: #e91e63; font-weight: bold; margin-bottom: 5px;">ğŸ‘¤ ä¸´æ—¶äººå‘˜ï¼š${record.temporaryCount}äºº</p>
                        <p><strong>ä¸´æ—¶äººå‘˜æ”¯ä»˜ï¼š</strong>Â¥${record.temporaryPayment.toFixed(2)}/äºº Ã— ${record.temporaryCount} = Â¥${record.totalTemporaryPayment.toFixed(2)}ï¼ˆç°é‡‘ï¼‰</p>
                        <p><strong>ä¸´æ—¶äººå‘˜åº”ä»˜ï¼š</strong>Â¥${record.temporaryShouldPay.toFixed(2)}ï¼ˆæŒ‰äººå¤´å¹³æ‘Šï¼‰</p>
                        <p style="color: #28a745;"><strong>å¤šä»˜é‡‘é¢ï¼š</strong>Â¥${record.temporaryExtra.toFixed(2)} â†’ å¹³å‡åˆ†ç»™${record.participants.length}ä¸ªå›ºå®šæˆå‘˜</p>
                        <p style="color: #28a745;"><strong>å›ºå®šæˆå‘˜æ¯äººè·å¾—ï¼š</strong>Â¥${record.temporaryIncomePerFixed.toFixed(2)}</p>
                    </div>
                `;
            }
            
            resultBox.innerHTML = `
                <h3>âœ… æœ¬æ¬¡åˆ†æ‘Šç»“æœ</h3>
                <p><strong>å›ºå®šæˆå‘˜å‚ä¸ï¼š</strong>${record.participants.join('ã€')}</p>
                <p><strong>æ€»æ¶ˆè´¹ï¼š</strong>Â¥${record.totalCost.toFixed(2)}</p>
                <p><strong>æ€»äººæ•°ï¼š</strong>${record.totalPeople}äºº (å›ºå®š${record.participants.length}äºº${record.temporaryCount > 0 ? ' + ä¸´æ—¶' + record.temporaryCount + 'äºº' : ''})</p>
                <p><strong>äººå‡åº”ä»˜ï¼š</strong>Â¥${record.perPersonCost.toFixed(2)}</p>
                ${temporaryInfo}
                <div class="result-amount" style="border-top: 2px dashed rgba(0,0,0,0.1); padding-top: 10px; margin-top: 10px;">
                    å›ºå®šæˆå‘˜å®é™…æ”¯ä»˜ï¼šÂ¥${record.fixedMemberActualCost.toFixed(2)}/äºº
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1);">
                    <p style="font-size: 13px;"><strong>æ¶ˆè´¹åå¡å†…ä½™é¢ï¼š</strong>Â¥${record.cardBalanceAfter.toFixed(2)}</p>
                    <p style="font-size: 13px;"><strong>æ¶ˆè´¹åç°é‡‘æ€»é¢ï¼š</strong>Â¥${record.cashTotalAfter.toFixed(2)}</p>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">è®°å½•æ—¶é—´ï¼š${record.date}</p>
            `;
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const historyPanel = document.getElementById('historyPanel');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyPanel.style.display = 'none';
                return;
            }

            historyPanel.style.display = 'block';
            historyList.innerHTML = '';
            
            history.forEach(record => {
                const div = document.createElement('div');
                div.className = 'history-item';
                
                let tempInfo = '';
                if (record.temporaryCount && record.temporaryCount > 0) {
                    tempInfo = ` | ä¸´æ—¶${record.temporaryCount}äºº(Â¥${record.totalTemporaryPayment.toFixed(2)})`;
                }
                
                const actualCost = record.fixedMemberActualCost || record.perPersonCost;
                
                div.innerHTML = `
                    <div class="history-date">${record.date}</div>
                    <div class="history-participants">å‚ä¸ï¼š${record.participants.join('ã€')}${tempInfo}</div>
                    <div class="history-amount">æ€»è®¡ï¼šÂ¥${record.totalCost.toFixed(2)} | å›ºå®šæˆå‘˜ï¼šÂ¥${actualCost.toFixed(2)}/äºº</div>
                `;
                historyList.appendChild(div);
            });
        }

        // é‡ç½®å½“å‰è¾“å…¥
        function resetCurrent() {
            selectedMembers.clear();
            document.getElementById('totalCost').value = '';
            document.getElementById('tempMembers').value = '0';
            document.getElementById('resultBox').style.display = 'none';
            
            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.members && Array.isArray(data.members)) {
                        members = data.members;
                        if (data.history) history = data.history;
                        if (data.cashTotal !== undefined) cashTotal = data.cashTotal;
                        if (data.cardBalance !== undefined) cardBalance = data.cardBalance;
                        if (data.nextMemberId !== undefined) {
                            nextMemberId = data.nextMemberId;
                        } else {
                            nextMemberId = members.length > 0 ? Math.max(...members.map(m => m.id)) + 1 : 1;
                        }
                        
                        saveToLocalStorage();
                        renderMembers();
                        renderCheckboxes();
                        renderHistory();
                        updateStats();
                        resetCurrent();
                        
                        alert('æ•°æ®åŠ è½½æˆåŠŸï¼');
                    } else {
                        alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
                    }
                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            e.target.value = '';
        });

        // ä¸‹è½½è®°å½•æ–‡ä»¶
        function downloadRecord() {
            const timestamp = new Date().toISOString().slice(0, 10);
            const data = {
                members: members,
                history: history,
                cashTotal: cashTotal,
                cardBalance: cardBalance,
                nextMemberId: nextMemberId,
                lastUpdate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `badminton-record-${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('è®°å½•æ–‡ä»¶å·²ä¸‹è½½ï¼');
        }
    </script>
</body>
</html>
